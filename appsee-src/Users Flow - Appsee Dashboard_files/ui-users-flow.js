function loadNavigationSankey(n,t,i,r,u,f,e,o){function ft(){return d3.biHiSankey().nodeWidth(fi).nodeSpacing(oi).linkSpacing(si).arrowheadScaleFactor(hi).size([i-w[0],r-w[1]]).nodes(s.nodes).links(s.links).initializeNodes(function(n){n.sourceValue=d3.sum(n.sourceLinks,function(n){return n.value});n.targetValue=d3.sum(n.targetLinks,function(n){return n.value});n.totalImpressions=Math.max(n.sourceValue,n.targetValue);n.state=n.parent?"contained":"collapsed"}).layout(ei)}function et(){s.nodes=li.slice(0);s.links=t.links.slice(0);s.linksDict={};s.links.forEach(function(n){n.source=n.sourceId;n.target=n.targetId;n.value=n.navigations;s.linksDict[n.sourceId+"-"+n.targetId]=n});s.nodes.forEach(function(n){delete n.height});a.others=$.extend({},a.otherCounts)}function yt(n){n=n?n:1;var t=!1,i=h.collapsedNodes();return i.forEach(function(r){t||i.forEach(function(i){t||r===i||r.x-n<=i.x+i.width+n&&r.x+r.width+n>=i.x-n&&r.y-n<=i.y+i.height+n&&r.y+r.height+n>=i.y-n&&(t=!0)})}),t}function ai(n){for(var t,o,h,r,u,f,e,i=s.links.length-1;i>=0;i--)(t=s.links[i],t.sourceId in n||t.targetId in n)&&(o=s.nodesIndex[t.sourceId],h=s.nodesIndex[t.targetId],o.type=="other"||h.type=="other"||t.sourceId in n&&t.targetId in n||(r=t.sourceId,u=t.targetId,t.sourceId in n?r=a.id:t.targetId in n&&(u=a.id),f=r+"-"+u,f in s.linksDict?s.linksDict[f].value+=t.value:(e={sourceId:r,targetId:u,source:r,target:u,value:t.value,navigations:t.value},s.links.push(e),s.linksDict[f]=e)),s.links.splice(i,1),delete s.linksDict[t.id])}function pt(n){for(var t,u=d3.quantile(s.nodes.filter(function(n){return n.type=="standard"}).map(function(n){return n.impressions}).sort(d3.ascending),n),r={},i=s.nodes.length-1;i>=0;i--)t=s.nodes[i],t.impressions<u&&t.type=="standard"&&(r[t.id]=!0,s.nodes.splice(i,1),t.screenType in a.others||(a.others[t.screenType]=0),a.others[t.screenType]+=1);ai(r)}function wt(n){if(n in ut)return ut[n];et();pt(n);h=ft();var t=!yt();return ut[n]=t,t}function ot(n,t,i){if(wt(n))return n;var r=(t+n)/2;return wt(r)?t-n<=i?r:Math.min(r,ot(n,r,i)):t-n<=i?Number.MAX_VALUE:ot(r,t,i)}function vi(n){n.dragged=!0;l.forceHide();n.x=Math.max(0,Math.min(i-n.width,d3.event.x));n.y=Math.max(0,Math.min(it-n.height,d3.event.y));d3.select(this).attr("transform","translate("+n.x+","+n.y+")");dt();h.relayout();y.selectAll("rect").attr("height",function(n){return n.height});v.attr("d",ii)}function bt(){ti.selectAll("g").remove()}function nt(){bt();v.style("marker-end",function(){return"url(#arrowHead)"}).style("opacity",null).classed({hover:!1,nodehover:!1,inflow:!1,outflow:!1,faded:!1});y.classed({hover:!1,faded:!1,nodehover:!1});p.classed({hover:!1,faded:!1,nodehover:!1})}function yi(n){function t(t){return function(r){var f=15,u=t?r.target:r.source,e=u.x<i/2,o=u.x+(e?g+u.width:-g),s=u.y+u.height/2+(t?+f:-f),h=e?"start":"end",c=(r.value/(t?n.sourceValue:n.targetValue)).toPercentageFormat(),l="link-label "+(t?"outflow":"inflow")+" "+r.source.type+" "+r.target.type;ti.append("g").attr("transform","translate("+o+","+s+")").attr("class",l).append("text").attr("y",".35em").attr("text-anchor",h).text(c)}}function r(n){var t=d3.extent(n,function(n){return n.value}),i=d3.scale.linear().domain([t[0]-1,t[1]]).range([.2,.4]);return function(n){return i(n.value)}}v.filter(function(t){return t.source===n}).classed("nodehover",!0).classed("outflow",!0).style("opacity",r(n.sourceLinks)).style("marker-end",function(n){return n.source.type=="crashed"||n.target.type=="crashed"?"url(#arrowHeadCrashed)":"url(#arrowHeadOutflow)"}).each(t(!0));v.filter(function(t){return t.target===n}).classed("nodehover",!0).classed("inflow",!0).style("opacity",r(n.targetLinks)).style("marker-end",function(n){return n.source.type=="crashed"||n.target.type=="crashed"?"url(#arrowHeadCrashed)":"url(#arrowHeadInflow)"}).each(t(!1));y.filter(function(t){return t===n?!1:h.connected(t,n)}).classed("nodehover",!0);p.filter(function(t){return t===n?!1:h.connected(t,n)}).classed("nodehover",!0)}function pi(n){v.filter(function(t){return t.source!==n&&t.target!==n}).classed("faded",!0).style("marker-end",function(){return"url(#arrowHead)"});y.filter(function(t){return t===n?!1:!h.connected(t,n)}).classed("faded",!0);p.filter(function(t){return t===n?!1:!h.connected(t,n)}).classed("faded",!0)}function st(n,t){nt();yi(n);pi(n);d3.select(t.parentElement).classed("hover",!0)}function ht(){c&&(c=null,d=null,nt())}function kt(n,t){c===n?ht():(st(n,t),c=n,d=t)}function dt(){lt.attr("transform",function(n){var t=n._parent?n._parent.x:n.x,i=n._parent?n._parent.y:n.y;return"translate("+t+","+i+")"});p.filter(function(n){return n.value!==0}).select("text").attr("x",-g).attr("y",function(n){return n.height/2}).attr("dy",".35em").attr("text-anchor","end").text(function(n){return n.name}).filter(function(n){return n.x<i/2}).attr("x",g+h.nodeWidth()).attr("text-anchor","start")}function b(n,t){vt.append("marker").attr("class","arrow "+t).attr("id",n).attr("viewBox","0 0 6 10").attr("refX","1").attr("refY","5").attr("markerUnits","strokeWidth").attr("markerWidth","1").attr("markerHeight","1").attr("orient","auto").append("path").attr("d","M 0 0 L 1 0 L 6 5 L 1 10 L 0 10 z")}function ct(n){return n.mouseup(function(){return!1}).mousedown(function(){return!1})}var fi=36,at=400,ei=32,oi=40,si=6,hi=.5,w=[0,40],g=3,ci=Math.floor(i/60),s={showZoom:!0},ut={},li=t.nodes.filter(function(n){return n.type!="standard"||n.impressions}),a=t.nodes.filter(function(n){return n.type=="other"})[0],vt,h,gt,ni,tt,it,rt;s.nodesIndex={};t.nodes.forEach(function(n){s.nodesIndex[n.id]=n});et();h=ft();s.nodes.length<ci&&!yt()?s.showZoom=!1:(gt=ot(0,1,.01),ni=d3.scale.sqrt().range([gt,.9])(f),et(),pt(ni),h=ft());n.selectAll("*").remove();tt=n.append("svg").attr("width",i).attr("height",r);tt.append("rect").attr("width",i).attr("height",r*100).style("fill","#fff").on("click",function(){ht()});var k=tt.append("g").attr("transform","translate("+w[0]/2+","+w[1]/2+")"),wi=k.append("g"),bi=k.append("g"),ki=k.append("g"),ti=k.append("g"),l=n.tooltip(300),ii=h.link().curvature(.45),v,ri,y,ui,p,lt,c,d;vt=k.append("defs");b("arrowHead","");b("arrowHeadInflow","inflow");b("arrowHeadOutflow","outflow");b("arrowHeadQuit","quit");b("arrowHeadCrashed","crashed");it=r;rt=Math.max.apply(Math,h.nodes().map(function(n){return n.y+n.height}));rt>r?(it=rt,tt.attr("height",it+w[1]),$(n.node()).height(r).css("overflow-y","scroll").css("display","inline-block").scrollTop(rt)):$(n.node()).css("overflow-y","").css("display","").height("auto");v=wi.selectAll("path.link").data(h.visibleLinks(),function(n){return n.id});ri=v.enter().append("path").attr("class",function(n){return"link "+n.source.type+" "+n.target.type}).style("fill","none").on("mouseenter",function(n){var i,t,u,r,f;if(c||nt(),i=d3.select(this),!i.classed("faded")){v.classed("hover",!1);i.classed("hover",!0);t=$("<div><\/div>");t.append($('<p class="link-title"><span class="screen-title">'+n.source.name+'<\/span> <i class="icon fa fa-arrow-right"><\/i> <span class="screen-title">'+n.target.name+"<\/span><\/p>"));u=n.value/(c?c===n.source?c.sourceValue:c.targetValue:n.source.sourceValue);r="<p>"+n.value.toKiloFormat();r+=n.target.type=="crashed"?" Crash"+(n.value==1?"":"es"):" Navigation"+(n.value==1?"":"s");r+=" ("+u.toPercentageFormat()+")<\/p>";t.append($(r));n.ap&&(f=appsee.getHash({action:"/sessions/index",actionParams:o(n)}),t.append(ct($('<p style="margin-top: 10px;"><a href="'+f+'" target="_blank" class="fasttip" title="Show sessions containing this navigation"><i class="icon fa fa-play-circle" style="font-size: 1.2em;"><\/i><\/a><\/p>'))));l.on("mouseup",function(){i.node().dispatchEvent(new MouseEvent("mouseup",d3.event))});l.on("mousedown",null);t.find(".fasttip").fasttip();l.show(t,null,function(){i.classed("hover",!1)})}}).on("mouseleave",function(){var n=d3.select(this);n.classed("faded")||l.hide()}).on("mouseup",function(){ht()});ri.sort(function(n,t){return t.thickness-n.thickness}).classed("leftToRight",function(n){return n.direction>0}).classed("rightToLeft",function(n){return n.direction<0}).style("marker-end",function(){return"url(#arrowHead)"}).transition().delay(at).duration(at).attr("d",ii).style("stroke-width",function(n){return Math.max(1,n.thickness)});y=bi.selectAll(".node").data(h.collapsedNodes(),function(n){return n.id});ui=y.enter().append("g").attr("class",function(n){return"node type-"+n.type}).attr("transform",function(n){var t=n._parent?n._parent.x:n.x,i=n._parent?n._parent.y:n.y;return"translate("+t+","+i+")"});ui.append("rect").attr("height",function(n){return n.height}).attr("width",h.nodeWidth()).on("mouseenter",function(n){var i=this,h=d3.select(i.parentElement),t,f,o,s,r,a,v;if(c||st(n,i),!h.classed("faded")){if(t=$("<div><\/div>"),f="javascript:0",n.screenId&&(f=appsee.getHash({action:"/uianalysis/index",actionParams:"?id="+n.screenId})),t.append($('<p class="screen-title" />').append($('<a href="'+f+'" target="_blank">'+n.name+"<\/a>").addClass("node type-"+n.type))),n.others)for(o in n.others)s=n.others[o],t.append($("<p>"+s.toKiloFormat()+" "+o+(s!=1?"s":"")+"<\/p>"));n.type=="standard"||n.type=="other"?(n.sessions&&t.append($("<p>"+n.sessions.toKiloFormat()+" Session"+(n.sessions!=1?"s":"")+"<\/p>")),t.append($("<p>"+n.totalImpressions.toKiloFormat()+" Impression"+(n.totalImpressions!=1?"s":"")+"<\/p>"))):t.append($("<p>"+n.totalImpressions.toKiloFormat()+" Session"+(n.totalImpressions!=1?"s":"")+"<\/p>"));n.targetLinks.length&&t.append($('<p class="inflow">'+n.targetLinks.length.toKiloFormat()+" Inbound screen"+(n.targetLinks.length!=1?"s":"")+"<\/p>"));n.sourceLinks.length&&t.append($('<p class="outflow">'+n.sourceLinks.length.toKiloFormat()+" Outbound screen"+(n.sourceLinks.length!=1?"s":"")+"<\/p>"));(n.type=="standard"||n.type=="open")&&(r=$('<p style="margin-top: 10px;" />'),t.append(r),n.type=="standard"&&(a=appsee.getHash({action:"/sessions/index",actionParams:"?screens="+n.name}),r.append(ct($('<a href="'+a+'" target="_blank" class="fasttip" title="Show sessions containing this screen"><i class="icon fa fa-play-circle" style="font-size: 1.2em;"><\/i><\/a>')))),v=appsee.getHash({action:"/uianalysis/navigation-paths",actionParams:"?userType="+u+"&hidePopupsAndMenus="+e+(n.type=="standard"?"&root="+n.shortId:"")}),r.append(ct($('<a href="'+v+'" target="_blank" style="margin-left: 10px" class="fasttip" title="Show Navigation Paths"><i class="icon fa fa-code-fork" style="font-size: 1.2em;"><\/a>'))));n.type=="other"&&t.append($('<p style="padding-top: 5px; color: #979797;">To expand - change zoom level<\/p>'));l.on("mouseup",function(){i.dispatchEvent(new MouseEvent("mouseup",d3.event))});l.on("mousedown",function(){i.dispatchEvent(new MouseEvent("mousedown",d3.event))});t.find(".fasttip").fasttip();l.show(t,null,function(){c||(h.classed("hover",!1),nt())})}}).on("mouseleave",function(){var n=d3.select(this.parentElement);n.classed("faded")||l.hide()}).on("mouseup",function(n){n.dragged||kt(n,this)});return y.call(d3.behavior.drag().origin(function(n){return n}).on("dragstart",function(n){c&&d&&c!==n&&bt();this.parentNode.appendChild(this)}).on("drag",vi).on("dragend",function(n){n.dragged=!1;c&&d&&st(c,d)})),p=ki.selectAll(".node").data(h.collapsedNodes(),function(n){return n.id}),lt=p.enter().append("g").attr("class",function(n){return"node type-"+n.type}).attr("id",function(n){return"node-label-"+n.id}),lt.append("text"),dt(),s.lockNode=function(t){var i=t.height?t:a;kt(i,y.filter(function(n){return i===n}).select("rect").node());$(n.node()).scrollTop(i.y+5)},s.getLockedNode=function(){return c},s}