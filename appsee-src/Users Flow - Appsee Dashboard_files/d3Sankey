d3.biHiSankey=function(){"use strict";function v(n){return n.y+n.height/2}function u(n){return n.value}function tt(n){n.sourceLinks=[];n.rightLinks=[];n.targetLinks=[];n.leftLinks=[];n.connectedNodes=[];n.children=[];n.ancestors=[]}function it(){t.forEach(function(n){a[n.id]=n;tt(n)})}function rt(){s=t.filter(function(n){return!n.children.length})}function ut(){p=t.filter(function(n){return n.children.length})}function b(n){n.children.forEach(function(n){n.ancestors=n.ancestors.concat(this.ancestors.concat([this]));b(n)},n)}function ft(){var n,i=[];t.forEach(function(t){n=a[t.parent];n?(t.parent=n,n.children.push(t)):(t.parent=null,i.push(t))});rt();ut();i.forEach(function(n){b(n)})}function et(){var n,t;i.forEach(function(i){n=a[i.source]||i.source;t=a[i.target]||i.target;i.id=i.source+"-"+i.target;i.source=n;i.target=t;n.sourceLinks.push(i);t.targetLinks.push(i)})}function h(n){return n.filter(function(n){return n.source.state==="collapsed"&&n.target.state==="collapsed"})}function ot(){s.forEach(function(n){n.sourceLinks.forEach(function(t){var r,u=t.target;s.indexOf(u)>=0&&(r=u.ancestors.filter(function(t){return n.ancestors.indexOf(t)<0}),r.forEach(function(r){var u={source:n,target:r,value:t.value,id:n.id+"-"+r.id};n.sourceLinks.push(u);r.targetLinks.push(u);i.push(u)}))});n.targetLinks.forEach(function(t){var r,u=t.source;s.indexOf(u)>=0&&(r=u.ancestors.filter(function(t){return n.ancestors.indexOf(t)<0}),r.forEach(function(r){var u={source:r,target:n,value:t.value,id:r.id+"-"+n.id};r.sourceLinks.push(u);n.targetLinks.push(u);i.push(u)}))})});p.forEach(function(n){n.sourceLinks.forEach(function(t){var r,u=t.target;s.indexOf(u)>=0&&(r=u.ancestors.filter(function(t){return n.ancestors.indexOf(t)<0}),r.forEach(function(r){var u={source:n,target:r,value:t.value,id:n.id+"-"+r.id};n.sourceLinks.push(u);r.targetLinks.push(u);i.push(u)}))})})}function st(){var n=d3.nest().key(function(n){return n.source.id+"->"+n.target.id}).entries(i).map(function(n){return n.values});i=n.map(function(n){return n.reduce(function(n,t){return{source:n.source,target:n.target,id:d3.min([n.id,t.id]),value:n.value+t.value}})})}function k(n){var t=Math.max(n.length-1,0)*r,i=d3.sum(n,u)*e;return i+t}function y(){t.forEach(function(n){n.value=Math.max(d3.sum(n.leftLinks,u),d3.sum(n.rightLinks,u));n.netFlow=d3.sum(h(n.targetLinks),u)-d3.sum(h(n.sourceLinks),u);n.height=Math.max(k(h(n.leftLinks)),k(h(n.rightLinks)));n.linkSpaceCount=Math.max(Math.max(n.leftLinks.length,n.rightLinks.length)-1,0)})}function ht(){var n,t;i.forEach(function(i){n=i.source;t=i.target;n.connectedNodes.indexOf(t)<0&&n.connectedNodes.push(t);t.connectedNodes.indexOf(n)<0&&t.connectedNodes.push(n)})}function ct(){var n=[];return i.filter(function(n){return n.target.x===n.source.x}).forEach(function(t){n.indexOf(t.target)<0&&n.push(t.target)}),n}function lt(){var n,i=d3.nest().key(function(n){return n.x}).sortKeys(d3.ascending).entries(t).map(function(n){return n.values});i.forEach(function(t){t.forEach(function(t){for(n=t.connectedNodes.map(function(n){return n.x});t.x>0&&n.indexOf(t.x-1)<0;)t.x-=1})})}function at(){var n=d3.min(t,function(n){return n.x}),i=d3.max(t,function(n){return n.x})-n;w=(o[0]-c)/i;t.forEach(function(n){n.x*=w})}function vt(){for(var i=t,n,r=0,u=function(t){n.indexOf(t.target)<0&&t.target.x===this.x&&n.push(t.target)},f=function(n){n.x=r;n.width=c;n.sourceLinks.forEach(u,n)};i.length;)n=[],i.forEach(f),i=n.length?n:ct(),r+=1;lt();at()}function d(){var n,r;t.forEach(function(n){n.rightLinks=[];n.leftLinks=[]});i.forEach(function(t){n=t.source;r=t.target;n.x<r.x?(n.rightLinks.push(t),r.leftLinks.push(t),t.direction=1):(n.leftLinks.push(t),r.rightLinks.push(t),t.direction=-1)})}function yt(n){t.forEach(function(t){t.y-=n})}function pt(n){function a(){var n,t,u;e=d3.min(s,function(i){return n=d3.sum(i,function(n){return n.linkSpaceCount}),t=d3.sum(i,function(n){return n.value}),u=o[1]-(i.length-1)*f-n*r,u/t});i.forEach(function(n){var t=Math.abs(n.source.x-n.target.x),i=n.value*e;t/i<4&&(e=.25*t/n.value)})}function y(){s.forEach(function(n){n.forEach(function(n,t){n.y=t;n.heightAllowance=n.value*e+r*n.linkSpaceCount})})}function p(){i.forEach(function(n){n.thickness=n.value*e})}function w(n){function t(n){return v(n.source)*n.value}s.forEach(function(i){i.forEach(function(i){if(i.rightLinks.length){var r=d3.sum(i.rightLinks,t)/d3.sum(i.rightLinks,u);i.y+=(r-v(i))*n}})})}function b(n){function t(n){return v(n.target)*n.value}s.slice().reverse().forEach(function(i){i.forEach(function(i){if(i.leftLinks.length){var r=d3.sum(i.leftLinks,t)/d3.sum(i.leftLinks,u);i.y+=(r-v(i))*n}})})}function c(){function n(n,t){return n.y-t.y}s.forEach(function(t){var i,r,e=0,s=t.length,u;for(t.sort(n),u=0;u<s;++u)i=t[u],r=e-i.y,r>0&&(i.y+=r),e=i.y+i.heightAllowance+f;if(r=e-f-o[1],r>0)for(i.y-=r,e=i.y,u=s-2;u>=0;--u)i=t[u],r=i.y+i.heightAllowance+f-e,r>0&&(i.y-=r),e=i.y})}var l,h,s=d3.nest().key(function(n){return n.x}).sortKeys(d3.ascending).entries(t).map(function(n){return n.values});for(a(),y(),p(),c(),h=1;n>0;--n)h*=.99,b(h),c(),w(h),c();l=d3.min(t,function(n){return n.y});yt(l)}function g(){function n(n,t){var i=n.direction>0?n.source:n.target,r=t.direction>0?t.source:t.target;return i.y-r.y}function i(n,t){var i=n.direction>0?n.target:n.source,r=t.direction>0?t.target:t.source;return i.y-r.y}t.forEach(function(t){t.rightLinks.sort(i);t.leftLinks.sort(n)});t.forEach(function(n){var t=0,i=0;n.rightLinks.forEach(function(n){n.direction>0?(n.sourceY=t,n.target.state==="collapsed"&&(t+=n.thickness+r)):(n.targetY=t,n.source.state==="collapsed"&&(t+=n.thickness+r))});n.leftLinks.forEach(function(n){n.direction<0?(n.sourceY=i,n.target.state==="collapsed"&&(i+=n.thickness+r)):(n.targetY=i,n.source.state==="collapsed"&&(i+=n.thickness+r))})})}var n={},c=24,f=8,r=5,l=0,o=[1,1],t=[],a={},p=[],s=[],i=[],w=1,e=1,nt=.5;return n.arrowheadScaleFactor=function(t){return arguments.length?(l=+t,n):l},n.collapsedNodes=function(){return t.filter(function(n){return n.state==="collapsed"})},n.connected=function(n,t){return n.connectedNodes.indexOf(t)>=0},n.expandedNodes=function(){return t.filter(function(n){return n.state==="expanded"})},n.layout=function(t){return vt(),d(),y(),pt(t),y(),g(),n},n.link=function(){function i(t){var i=t.thickness*l,o=3*t.thickness/4-i,r=t.source.x+t.source.width,h=r+i/2,u=t.target.x-o-i,s=d3.interpolateNumber(r,u),c=s(n),a=s(1-n),f=t.source.y+t.sourceY+t.thickness/2,e=t.target.y+t.targetY+t.thickness/2;return"M"+r+","+f+"L"+h+","+f+"C"+c+","+f+" "+a+","+e+" "+u+","+e+"L"+(u+o)+","+e}function r(t){var e=t.thickness*l,o=t.thickness/4,i=t.source.x,h=i-e/2,r=t.target.x+t.target.width+o+e,s=d3.interpolateNumber(i,r),c=s(n),a=s(1-n),u=t.source.y+t.sourceY+t.thickness/2,f=t.target.y+t.targetY+t.thickness/2;return"M"+i+","+u+"L"+h+","+u+"C"+c+","+u+" "+a+","+f+" "+r+","+f+"L"+(r-o)+","+f}function t(n){return n.source.x<n.target.x?i(n):r(n)}var n=nt;return t.curvature=function(i){return arguments.length?(n=+i,t):n},t},n.links=function(t){return arguments.length?(i=t.filter(function(n){return n.source!==n.target}),n):i},n.linkSpacing=function(t){return arguments.length?(r=+t,n):r},n.nodes=function(i){return arguments.length?(t=i,n):t},n.nodeWidth=function(t){return arguments.length?(c=+t,n):c},n.nodeSpacing=function(t){return arguments.length?(f=+t,n):f},n.relayout=function(){return d(),y(),g(),n},n.size=function(t){return arguments.length?(o=t,n):o},n.visibleLinks=function(){return h(i)},n.initializeNodes=function(i){return it(),ft(),et(),ot(),st(),ht(),t.forEach(i),n},n}